pipeline {
  agent any
  environment {
      PATH = "/var/lib/jenkins/aws:$PATH"
      OPERATION = "create"
  }
  stages {
    stage('Zip up lambda') {
        steps {
                sh 'zip "lambdag.zip" "lambda_function.py"'
            }
        }     
         stage("Upload"){
        steps{
               script { 
                withAWS(region: "us-east-1", credentials:"awscr") {
                    s3Upload(bucket:"lambafairi", workingDir:'',includePathPattern:'**/*.zip')
                                                                  }    
              }
                }
                }
        stage('cloud formation stack creation to launch lambda function') {
            steps {
                    script {
                     withAWS(region: "us-east-1", credentials:"awscr") {
                     sh '''
                     #!/bin/bash
                       output=$(aws cloudformation update-stack --stack-name foo 2>&1)
                       RESULT=$?
                       if [ $RESULT -eq 0 ]; then
                          echo "$output"
                       else
                         if [[ "$output" == *"No updates are to be performed"* ]]; then
                           echo "No cloudformation updates are to be performed."
                           exit 0
                         else
                          echo "$output"
                          exit $RESULT
                        fi
                      fi
                  '''
              }
              }
             }
             }
        stage('remove the pushed zip folder') {
     steps {
            sh 'rm -rf *.zip'
          }
       }
    }
    }
